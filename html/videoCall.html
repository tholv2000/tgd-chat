<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>WebRTC Video Conferencing Application</title>
</head>
<body>
	<!-- Title & header of demo aplication. -->
	<div>
		<h3 style="position: relative; left: 10px;">WebRTC
		</h3>
	</div>

	<div>
		<button id="callBtn">Call</button>
		<button id="answerBtn">Answer</button>
	</div>
 
	<!-- Other person's camera video will show up here -->
	<div>
		<h3 style="margin: 5px">Other Person</h3>
		<video style="width: 50vh; height: 50vh;" id="remoteVideo" control autoplay></video>
	</div>
 
	<!-- Your camera video will show up here. -->
	<div>
		<h3 style="margin: 5px">You</h3>
		<video style="width: auto; height: 20vh;" id="localVideo" controls autoplay></video>
	</div>

	<p id="signal"></p>
 
	<!-- Button to leave video conference. -->
	<div class="box">
		<button id="leaveButton" style="background-color: #008CBA; color: white; ">Leave Video</button>
	</div>
	<script type="text/javascript" src="../js/simplepeer.min.js"></script>
	<script>
		let peerConnection = new SimplePeer({
			initiator: location.hash === '#1',
			trickle: false
		})

		let offerSignal;
		let sendSignal;
		let firstTime = true;

		const callBtn = document.getElementById('callBtn');
		const answerBtn = document.getElementById('answerBtn');

		let signalingWebsocket = new WebSocket("ws://https://chatwebapp-websocketserver.herokuapp.com/videochat");

		signalingWebsocket.onmessage = async function(msg) {
			console.log("Got message", msg.data);
			const signal = JSON.parse(msg.data);
			if (signal.type === "offer") {
				offerSignal = signal;
				if (firstTime) {
					peerConnection.signal(signal);
					const newStream = await navigator.mediaDevices.getUserMedia({
						video: true,
						audio: false,
					});

					peerConnection.addStream(newStream);
					firstTime = false;
				}
			}
			if (signal.type === "answer") peerConnection.signal(signal);
		};

		signalingWebsocket.onopen = () => {
			console.log('Opened');
			document.getElementById("signal").innerHTML = "Hello "
		}

		signalingWebsocket.onerror = () => {
			console.log('Error');
			document.getElementById("signal").innerHTML = "Error"
		}

		peerConnection.on('error', err => console.log('error', err))

		peerConnection.on('connect', () => {
			console.log('Connect');
			peerConnection.send('Hello guy');
		})

		peerConnection.on('data', (data) => {
			console.log(data);
		})

		peerConnection.on('signal', (data) => {
			console.log(data);
			document.getElementById("signal").innerHTML = JSON.stringify(data);
			signalingWebsocket.send(JSON.stringify(data));
		})

		peerConnection.on('stream', async (stream) => {
			const remoteVideo = document.getElementById('remoteVideo');
			console.log(remoteVideo);
			remoteVideo.srcObject = stream;
			remoteVideo.play();
		})

		async function call(initator, offer) {
			console.log('Calling...');

			const stream = await navigator.mediaDevices.getUserMedia({
				video: true,
				audio: false,
			});

			const localVideo = document.getElementById('localVideo');
			localVideo.srcObject = stream;
			localVideo.play();

			peerConnection.addStream(stream);
		}

		async function answer() {
			if (offerSignal) peerConnection.signal(offerSignal);

			const stream = await navigator.mediaDevices.getUserMedia({
					video: true,
					audio: false,
			});

			const localVideo = document.getElementById('localVideo');
			localVideo.srcObject = stream;
			localVideo.play();
		}

		callBtn.addEventListener('click', (e) => call());
		answerBtn.addEventListener('click', (e) => answer());
	</script>
</body>
</html>
